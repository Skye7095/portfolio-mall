<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
  
<mapper namespace="com.portfolio.mall.cart.dao.CartDAO">
	<!-- 장바구니 개별 cart 추가 -->
	<insert id="insertCart" parameterType="map">
		INSERT INTO
			`cart`
		(
			`buyerId`
			, `productId`
			, `productAmount`
			, `productSumPrice`
			, `productTotalPrice`
			, `createdAt`
			, `updatedAt`
		)
		VALUE
		(
			#{buyerId}
			, #{productId}
			, #{productAmount}
			, #{productSumPrice}
			, #{productTotalPrice}
			, now()
			, now()
		)
	</insert>

	<!-- 장바구니 개별 cart 추가 -->
	<insert id="insertCartDecision" parameterType="map">
		INSERT INTO
			`cartDecision`
		(
			`buyerId`
			, `buyerOrderId`
			, `productId`
			, `productAmount`
			, `productSumPrice`
			, `productTotalPrice`
			, `createdAt`
			, `updatedAt`
		)
		VALUE
		(
			#{buyerId}
			, #{buyerOrderId}
			, #{productId}
			, #{productAmount}
			, #{productSumPrice}
			, #{productTotalPrice}
			, now()
			, now()
		)
	</insert>
	
	<!-- 같은 buyer가 같은 product를 추가했는지 조회 -->
	<select id="selectSameCart" parameterType="map" resultType="int">
		SELECT 
			count(1)
		FROM
			`cart`
		WHERE
			`buyerId` = #{buyerId} AND `productId`= #{productId}
	</select>
	
	<!-- 같은 buyer가 같은 product를 추가했는지 조회 -->
	<select id="selectSameCartDecision" parameterType="map" resultType="int">
		SELECT 
			count(1)
		FROM
			`cartDecision`
		WHERE
			`buyerId` = #{buyerId} AND `productId`= #{productId}
	</select>

	<!-- 장바구니 페이지 상품 조회 -->
	<select id="selectCartList" parameterType="int" resultType="com.portfolio.mall.cart.model.Cart">
		SELECT
			`id`
			, `buyerId`
			, `productId`
			, `productAmount`
			, `productSumPrice`
			, `productTotalPrice`
			, `createdAt`
			, `updatedAt`
		FROM
			`cart`
		WHERE `buyerId` = #{buyerId}
		ORDER BY `id` DESC
	</select>

	<!-- 장바구니페이지 개별 상품 삭제하기 -->
	<delete id="deleteCart" parameterType="int">
		DELETE FROM
			`cart`
		WHERE
			`id` = #{cartId}
	</delete>
	
	<!-- 장바구니페이지 개별 상품 삭제하기 > cartDecision테이블에서-->
	<delete id="deleteCartDecision" parameterType="int">
		DELETE FROM
			`cartDecision`
		WHERE
			`id` = #{cartId}
	</delete>

	<!-- cartDecision buyerOrderId 수정 -->
	<update id="updateCartDecision" parameterType="map">
		UPDATE
			`cartDecision`
		SET
			`buyerOrderId` = #{buyerOrderId}
		WHERE
			`buyerId` = #{buyerId} AND `buyerOrderId` = '0'
	</update>
	
	<!-- buyerOrderId로 cartDecisionList 조회 -->
	<select id="selectCartDecisionList" parameterType="String" resultType="com.portfolio.mall.cart.model.CartDecision">
		SELECT
			`id`
			, `buyerId`
			, `buyerOrderId`
			, `productId`
			, `productAmount`
			, `productSumPrice`
			, `productTotalPrice`
			, `createdAt`
			, `updatedAt`
		FROM
			`cartDecision`
		WHERE `buyerOrderId` = #{buyerOrderId}
		ORDER BY `id` DESC
	</select>
	
	<!-- 장바구니 결제완료 후 cart테이블 같은 buyerId 삭제 -->
	<delete id="deleteCartList" parameterType="int">
		DELETE FROM
			`cart`
		WHERE
			`buyerId` = #{buyerId}
	</delete>
</mapper>